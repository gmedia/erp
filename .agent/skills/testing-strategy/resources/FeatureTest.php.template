<?php

namespace Tests\Feature;

use App\Models\{{Feature}};
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

/**
 * Feature tests for {{Feature}}Controller.
 *
 * TESTING GUIDELINES:
 * - Test semua CRUD operations
 * - Test validation errors
 * - Test authorization jika ada permissions
 * - Gunakan factories untuk test data
 */
class {{Feature}}ControllerTest extends TestCase
{
    use RefreshDatabase;

    private User $user;

    protected function setUp(): void
    {
        parent::setUp();
        $this->user = User::factory()->create();
        // Setup permissions jika perlu
        // $this->user->givePermissionTo('{{feature}}');
    }

    // ==================== INDEX ====================
    
    public function test_index_returns_paginated_{{features}}(): void
    {
        {{Feature}}::factory()->count(20)->create();

        $response = $this->actingAs($this->user)
            ->getJson('/api/{{features}}?per_page=10');

        $response->assertOk()
            ->assertJsonCount(10, 'data')
            ->assertJsonStructure([
                'data' => [['id', 'name']],
                'meta' => ['current_page', 'total'],
            ]);
    }

    public function test_index_can_search(): void
    {
        {{Feature}}::factory()->create(['name' => 'Alpha']);
        {{Feature}}::factory()->create(['name' => 'Beta']);

        $response = $this->actingAs($this->user)
            ->getJson('/api/{{features}}?search=Alpha');

        $response->assertOk()
            ->assertJsonCount(1, 'data');
    }

    // ==================== STORE ====================

    public function test_store_creates_{{feature}}(): void
    {
        $data = ['name' => 'New {{Feature}}'];

        $response = $this->actingAs($this->user)
            ->postJson('/api/{{features}}', $data);

        $response->assertCreated()
            ->assertJsonPath('data.name', 'New {{Feature}}');

        $this->assertDatabaseHas('{{features}}', $data);
    }

    public function test_store_validates_required_fields(): void
    {
        $response = $this->actingAs($this->user)
            ->postJson('/api/{{features}}', []);

        $response->assertUnprocessable()
            ->assertJsonValidationErrors(['name']);
    }

    // ==================== SHOW ====================

    public function test_show_returns_{{feature}}(): void
    {
        ${{feature}} = {{Feature}}::factory()->create();

        $response = $this->actingAs($this->user)
            ->getJson("/api/{{features}}/{${{feature}}->id}");

        $response->assertOk()
            ->assertJsonPath('data.id', ${{feature}}->id);
    }

    public function test_show_returns_404_for_nonexistent(): void
    {
        $response = $this->actingAs($this->user)
            ->getJson('/api/{{features}}/999');

        $response->assertNotFound();
    }

    // ==================== UPDATE ====================

    public function test_update_modifies_{{feature}}(): void
    {
        ${{feature}} = {{Feature}}::factory()->create();
        $data = ['name' => 'Updated Name'];

        $response = $this->actingAs($this->user)
            ->putJson("/api/{{features}}/{${{feature}}->id}", $data);

        $response->assertOk()
            ->assertJsonPath('data.name', 'Updated Name');
    }

    // ==================== DESTROY ====================

    public function test_destroy_deletes_{{feature}}(): void
    {
        ${{feature}} = {{Feature}}::factory()->create();

        $response = $this->actingAs($this->user)
            ->deleteJson("/api/{{features}}/{${{feature}}->id}");

        $response->assertNoContent();
        $this->assertDatabaseMissing('{{features}}', ['id' => ${{feature}}->id]);
    }
}
